{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://leakwatch.dev/schemas/normalizedInvoice.schema.json",
  "title": "NormalizedInvoice",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "source", "merchant", "vendor", "invoice", "lineItems", "quality"],
  "properties": {
    "schemaVersion": { "type": "string", "const": "1.0" },
    "source": {
      "type": "object",
      "additionalProperties": false,
      "required": ["documentVersionId", "sourceType", "fileName", "mimeType", "sha256"],
      "properties": {
        "documentVersionId": { "type": "string", "minLength": 1 },
        "sourceType": { "type": "string", "enum": ["UPLOAD", "EMAIL_FORWARD"] },
        "fileName": { "type": "string", "minLength": 1 },
        "mimeType": { "type": "string", "minLength": 1 },
        "sha256": {
          "type": "string",
          "pattern": "^[a-fA-F0-9]{64}$"
        }
      }
    },
    "merchant": {
      "type": "object",
      "additionalProperties": false,
      "required": ["shopId", "shopifyDomain", "contactEmail"],
      "properties": {
        "shopId": { "type": "string", "minLength": 1 },
        "shopifyDomain": { "$ref": "#/$defs/nullableString" },
        "contactEmail": { "$ref": "#/$defs/nullableString" }
      }
    },
    "vendor": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "canonicalName", "supportEmail", "website", "category"],
      "properties": {
        "name": { "type": "string", "minLength": 1 },
        "canonicalName": { "$ref": "#/$defs/nullableString" },
        "supportEmail": { "$ref": "#/$defs/nullableString" },
        "website": { "$ref": "#/$defs/nullableString" },
        "category": {
          "anyOf": [
            {
              "type": "string",
              "enum": ["SHOPIFY_APP", "SAAS", "PAYMENT", "SHIPPING", "MARKETING", "ANALYTICS", "UNKNOWN"]
            },
            { "type": "null" }
          ]
        }
      }
    },
    "invoice": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "invoiceNumber",
        "invoiceDate",
        "billingPeriodStart",
        "billingPeriodEnd",
        "currency",
        "subtotalAmount",
        "taxAmount",
        "totalAmount",
        "paymentMethodHint",
        "notes"
      ],
      "properties": {
        "invoiceNumber": { "$ref": "#/$defs/nullableString" },
        "invoiceDate": { "$ref": "#/$defs/nullableDateTimeString" },
        "billingPeriodStart": { "$ref": "#/$defs/nullableDateTimeString" },
        "billingPeriodEnd": { "$ref": "#/$defs/nullableDateTimeString" },
        "currency": { "type": "string", "pattern": "^[A-Z]{3}$" },
        "subtotalAmount": { "$ref": "#/$defs/nullableDecimalString" },
        "taxAmount": { "$ref": "#/$defs/nullableDecimalString" },
        "totalAmount": { "$ref": "#/$defs/decimalString" },
        "paymentMethodHint": { "$ref": "#/$defs/nullableString" },
        "notes": { "$ref": "#/$defs/nullableString" }
      }
    },
    "lineItems": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "lineId",
          "type",
          "description",
          "quantity",
          "unitPrice",
          "amount",
          "currency",
          "periodStart",
          "periodEnd",
          "isRecurring",
          "recurringCadence",
          "planName",
          "productCode",
          "taxAmount",
          "evidence"
        ],
        "properties": {
          "lineId": { "type": "string", "minLength": 1 },
          "type": { "type": "string", "enum": ["CHARGE", "REFUND", "CREDIT"] },
          "description": { "$ref": "#/$defs/nullableString" },
          "quantity": { "$ref": "#/$defs/nullableDecimalString" },
          "unitPrice": { "$ref": "#/$defs/nullableDecimalString" },
          "amount": { "$ref": "#/$defs/decimalString" },
          "currency": { "type": "string", "pattern": "^[A-Z]{3}$" },
          "periodStart": { "$ref": "#/$defs/nullableDateTimeString" },
          "periodEnd": { "$ref": "#/$defs/nullableDateTimeString" },
          "isRecurring": { "$ref": "#/$defs/nullableBoolean" },
          "recurringCadence": {
            "anyOf": [
              { "type": "string", "enum": ["MONTHLY", "YEARLY", "WEEKLY", "ONE_TIME"] },
              { "type": "null" }
            ]
          },
          "planName": { "$ref": "#/$defs/nullableString" },
          "productCode": { "$ref": "#/$defs/nullableString" },
          "taxAmount": { "$ref": "#/$defs/nullableDecimalString" },
          "evidence": {
            "type": "object",
            "additionalProperties": false,
            "required": ["kind", "pointer", "excerpt"],
            "properties": {
              "kind": { "type": "string", "enum": ["PDF_TEXT_SPAN", "CSV_ROW", "IMAGE_OCR_LINE"] },
              "pointer": {
                "type": "object",
                "additionalProperties": false,
                "required": ["page", "lineStart", "lineEnd", "row", "col"],
                "properties": {
                  "page": { "$ref": "#/$defs/nullablePositiveInteger" },
                  "lineStart": { "$ref": "#/$defs/nullablePositiveInteger" },
                  "lineEnd": { "$ref": "#/$defs/nullablePositiveInteger" },
                  "row": { "$ref": "#/$defs/nullablePositiveInteger" },
                  "col": { "$ref": "#/$defs/nullableString" }
                }
              },
              "excerpt": { "type": "string", "minLength": 1, "maxLength": 300 }
            }
          }
        }
      }
    },
    "quality": {
      "type": "object",
      "additionalProperties": false,
      "required": ["confidence", "missingFields", "warnings"],
      "properties": {
        "confidence": { "type": "integer", "minimum": 0, "maximum": 100 },
        "missingFields": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        },
        "warnings": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 }
        }
      }
    }
  },
  "$defs": {
    "nullableString": {
      "anyOf": [{ "type": "string" }, { "type": "null" }]
    },
    "nullableBoolean": {
      "anyOf": [{ "type": "boolean" }, { "type": "null" }]
    },
    "nullableDateTimeString": {
      "anyOf": [{ "type": "string", "format": "date-time" }, { "type": "null" }]
    },
    "decimalString": {
      "type": "string",
      "pattern": "^-?\\d+(\\.\\d+)?$"
    },
    "nullableDecimalString": {
      "anyOf": [{ "$ref": "#/$defs/decimalString" }, { "type": "null" }]
    },
    "nullablePositiveInteger": {
      "anyOf": [{ "type": "integer", "minimum": 1 }, { "type": "null" }]
    }
  }
}
