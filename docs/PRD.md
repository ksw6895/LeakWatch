# PRD — LeakWatch

## 1) 배경/문제
- Shopify 스토어 성장 시 앱/SaaS 구독이 25~40개 이상으로 급증
- 청구서는 Shopify invoice, 카드 명세, SaaS 인보이스, 이메일 등으로 파편화
- 재무 전담이 없으면 “왜 늘었는지/중복인지/해지 후 과금인지”를 놓치고 반복 손실 발생
- 해지/환불 커뮤니케이션이 번거롭고 증빙 정리가 어렵다

## 2) 목표 사용자(ICP)
- 앱 25~40개 사용, 월 GMV $100k~$400k, 팀 3~6명, 재무 담당 부재 D2C 운영팀
- (확장) Shopify 전문 에이전시(다수 스토어), 멀티채널 셀러

## 3) 핵심 가치(한 줄)
“인보이스를 AI가 표준화해서 누수를 ‘근거 포함’으로 찾고, 해지/환불을 ‘승인 1번’으로 실행 준비·발송·추적한다.”

## 4) 사용자 스토리(필수)
### 4.1 Onboarding/연동
- US-01: (Owner) Shopify 스토어에서 LeakWatch를 설치하고 앱을 열면, 내 스토어가 자동으로 연결된다.
- US-02: (Owner) 앱 안에서 내 팀원을 초대(또는 멤버 추가)해 함께 볼 수 있다. (MVP: 멤버 초대는 선택; 최소는 Owner 1명)
- US-03: (Owner) 내 스토어의 기본 통화/타임존/연락 이메일을 설정한다.

### 4.2 인보이스 업로드/수집
- US-10: (User) PDF/CSV/이미지 인보이스를 업로드하면 자동으로 처리 상태가 보인다.
- US-11: (User) 같은 벤더 인보이스를 여러 번 올려도 “버전”으로 추적되고 최신/이전 비교가 가능하다.
- US-12: (User) 파싱 실패 시 실패 원인(파일 타입/텍스트 추출 실패/스키마 오류)을 보고 재시도할 수 있다.

### 4.3 표준화/정규화
- US-20: (User) 업로드한 인보이스가 표준 JSON으로 변환되어, 벤더/플랜/기간/금액/통화/라인아이템이 한 눈에 보인다.
- US-21: (User) 필수 필드 누락 시 시스템이 자동으로 보정 시도하고, 그래도 실패하면 어떤 필드가 없었는지 알려준다.

### 4.4 누수 탐지/근거
- US-30: (User) 누수 후보(LeakFinding) Top 리스트를 보고, 예상 절감액과 신뢰도를 확인한다.
- US-31: (User) LeakFinding을 클릭하면 “왜 누수인지” 설명과 함께 원문 근거(페이지/라인/행)를 확인한다.
- US-32: (User) 누수 후보를 “정상(무시)” 처리하면 다음 리포트에서 제외된다(재발 시 재오픈 규칙 포함).

### 4.5 액션 센터(메일/증빙/승인/추적)
- US-40: (User) LeakFinding에서 “환불 요청/해지 요청/다운그레이드 요청” 액션을 생성하면 이메일 초안이 자동 생성된다.
- US-41: (User) 증빙 패키지(요약 + 관련 인보이스 파일 + 근거 텍스트)가 자동 생성되어 첨부 가능하다.
- US-42: (User) 이메일 초안을 수정하고 승인하면 발송되며, 발송 성공/실패 상태를 확인한다.
- US-43: (User) 벤더가 응답했는지/환불 완료했는지 상태를 추적할 수 있다.
  - MVP: 응답/완료는 사용자 수동 업데이트 가능 + 발송상태 자동
  - V1: 인바운드 메일로 응답 자동 수집(선택)

### 4.6 리포트/알림
- US-50: (User) 주간/월간 리포트를 앱 내에서 보고 이메일로도 받는다.
- US-51: (Agency) 여러 스토어를 묶어 “스토어별 Top5 누수 + 절감액” 리포트를 생성한다.

## 5) MVP 기능 요구사항(명세)
### 5.1 업로드/스토리지
- 지원 파일: PDF, CSV, JPG/PNG(최소 2종, 권장 3종)
- 최대 파일 크기: 20MB (ASSUMPTION; 비용/성능 상 안전)
- 최대 페이지 수: 20페이지 (ASSUMPTION; 초과 시 분할 업로드 유도)
- 저장: R2 object + DB metadata + checksum
- 버전: 동일 Document에 version 번호 증가

### 5.2 LLM 표준화
- 출력은 /docs/NORMALIZATION_SCHEMA.md 의 JSON Schema를 “strict”로 만족해야 함
- 스키마 밸리데이션 실패 시:
  1) 자동 repair prompt 1회
  2) 그래도 실패하면 `NORMALIZATION_FAILED`로 저장하고 UI에서 필수필드 누락 표시

### 5.3 누수 탐지 v1(최소 5종)
- L-01 전월 대비 급등(동일 벤더/플랜 기준)
- L-02 중복 결제(동일 기간/동일 금액/유사 라인 반복)
- L-03 해지 이후 과금(우리 시스템의 “해지 요청 승인/발송” 이후 동일 벤더 청구 지속)
- L-04 트라이얼 종료 후 자동 결제 의심(첫 유료 결제 + 무료/0원 이벤트 흔적)
- L-05 설치되지 않은 앱인데 청구됨(Shopify 설치 앱 목록과 불일치 가능한 경우)
  - 설치 앱 목록이 불가한 환경에서는 L-05는 “옵션 탐지”로 downgrade하고 confidence 하향(ASSUMPTION)

### 5.4 액션
- 액션 타입: RefundRequest, CancelRequest, DowngradeRequest, Clarification
- 기본 실행: 이메일 발송(Mailgun) + 첨부(증빙 Zip)
- 승인: 사용자(Owner/Member) 승인 필요(자동 발송 금지)
- 추적: 발송 상태 + 사용자 수동 상태(WaitingReply/Resolved)

## 6) 비기능 요구사항(NFR)
- 보안: OAuth 토큰/메일건 API키/LLM 키는 KMS 또는 AES-256-GCM으로 암호화 저장
- 멀티테넌시: Org/Shop boundary를 코드 레벨에서 강제(모든 쿼리에 org_id 필터)
- 성능: 업로드 후 5분 내(ASSUMPTION) “정규화+탐지 결과”가 대시보드에 반영
- 신뢰성: 워커 재시도/백오프, idempotency
- 관측성: 모든 background job에 job_id/correlation_id 로그 포함

## 7) 성공 지표(측정 가능)
- Activation: 설치 후 24h 내 문서 1개 이상 업로드 비율
- TTV: 첫 업로드 후 30분 내 LeakFinding 1개 이상 생성 비율
- Action: LeakFinding→ActionRequest 생성률, 승인률, 발송 성공률
- Savings: “예상 절감액” 및 “확정 절감액”(환불/해지 확인 기반)
- Retention: 주간 리포트 구독 유지율

## 8) ASSUMPTIONS(가정) & 검증 방법(요약)
- A1: 인보이스에서 텍스트 추출이 가능하다(텍스트 PDF 또는 이미지 기반 OCR/비전으로 추출 가능)
  - 검증: 샘플 30개로 추출 성공률 측정(>90%)
  - 대안: 실패 시 사용자에게 CSV 템플릿 제공 + 수동 입력 UX
- A2: Shopify 설치 앱 목록을 API로 조회 가능하다(또는 제한적)
  - 검증: 개발 스토어에서 GraphQL query 테스트
  - 대안: 설치 앱 목록은 UI에서 “현재 설치 앱 업로드/입력”으로 대체
- A3: 이메일을 LeakWatch 도메인으로 보내도 벤더가 처리한다
  - 검증: 주요 벤더 10곳에 테스트 케이스 발송
  - 대안: “Copy email + mailto” 모드 제공(사용자 로컬 메일 클라이언트로 발송)
